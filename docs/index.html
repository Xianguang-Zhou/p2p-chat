<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>P2P chat</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
		integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css"
		integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">
	<link href="style.css" rel="stylesheet">
</head>

<body>
	<div id="app" class="container-fluid">
		<div class="row line">
			<form class="form-inline" onsubmit="return false">
				<div class="form-group">
					<label for="peerIdInput">Peer ID: </label>
					<input id="peerIdInput" type="text" class="form-control" v-model="selfPeerId" readonly>
				</div>
				<button id="copySelfPeerId" v-if="selfPeerId" class="btn btn-default">copy</button>
			</form>
		</div>
		<div class="row line">
			<form class="form-inline" onsubmit="return false">
				<div class="form-group">
					<label for="friendPeerIdInput">Friend peer ID: </label>
					<input id="friendPeerIdInput" v-model="friendPeerId" class="form-control">
				</div>
				<input type="button" value="connect" v-on:click="connectPeer" v-if="selfPeerId" class="btn btn-default">
			</form>
		</div>
		<div class="row line">
			<label style="margin:0">Status:&nbsp;</label><span>{{ status }}</span>
		</div>
		<div class="row line">
			<div id="messagesContainer" class="col-xs-12">
				<p v-for="(msg, index) in messageList" :key="index" class="message">
					<span class="messageName">{{ msg.name }}</span>:&nbsp;
					<template v-if="msg.type === 'img'">
						<br><img v-bind:src="msg.content" v-on:load="onImageLoad" class="messageImage">
					</template>
					<template v-else>
						<span class="messageText">{{ msg.content }}</span>
					</template>
				</p>
			</div>
		</div>
		<div class="row line">
			<input type="button" value="image" v-on:click="selectImages" class="btn btn-default">
		</div>
		<div class="row line">
			<textarea cols="45" rows="4" v-model="message" v-on:keyup.ctrl.enter.exact.stop="sendMessage"
				class="form-control col-xs-12"></textarea>
		</div>
		<div class="row line">
			<input type="button" value="send" v-on:click="sendMessage" class="btn btn-default">
		</div>
		<input type="file" id="imageInput" multiple v-on:change="sendImages">
	</div>
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
		integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue"></script>
	<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/peerjs@0.3.20/dist/peer.min.js"></script>
	<script>
		$(document).ready(function () {
			const app = new Vue({
				el: '#app',
				data: {
					friendPeerId: '',
					selfPeerId: '',
					status: 'getting peer ID...',
					message: '',
					messageList: []
				},
				methods: {
					connectPeer: function () {
						this.status = 'connecting...';
						const conn = peer.connect(this.friendPeerId);
						this.conn = conn;
						conn.on('open', () => {
							this.friendPeerId = conn.peer;
							this.status = 'connected';
						});
						conn.on('close', () => {
							this.status = 'disconnected';
						});
						conn.on('data', (data) => {
							if (data.type === 'img') {
								const imageBlob = new Blob([data.content], { type: data.fileType });
								const imageUrl = URL.createObjectURL(imageBlob);
								this.messageList.push({ type: 'img', name: 'friend', content: imageUrl });
							} else {
								this.messageList.push({ type: 'text', name: 'friend', content: data.content });
							}
						});
					},
					sendMessage: function () {
						this.messageList.push({ type: 'text', name: 'me', content: this.message });
						this.conn.send({ type: 'text', content: this.message });
						this.message = '';
					},
					sendImages: function (event) {
						for (const imageFile of event.target.files) {
							const imageUrl = URL.createObjectURL(imageFile);
							this.messageList.push({ type: 'img', name: 'me', content: imageUrl });
							const reader = new FileReader();
							reader.onload = function (readerEvent) {
								app.conn.send({ type: 'img', fileType: imageFile.type, content: readerEvent.target.result });
							};
							reader.readAsArrayBuffer(imageFile);
						}
					},
					onImageLoad: function (event) {
						const src = event.target.src;
						if (src.startsWith('blob:')) {
							window.URL.revokeObjectURL(src);
						}
					},
					selectImages: function () {
						$('#imageInput').click();
					}
				},
			});
			const clipboard = new ClipboardJS('#copySelfPeerId', {
				text: function (trigger) {
					return app.selfPeerId;
				}
			});
			const peer = new Peer();
			peer.on('open', (id) => {
				app.selfPeerId = id;
				app.status = 'online';
			});
			peer.on('connection', (conn) => {
				app.conn = conn;
				conn.on('open', () => {
					app.friendPeerId = conn.peer;
					app.status = 'connected';
				});
				conn.on('close', () => {
					app.status = 'disconnected';
				});
				conn.on('data', (data) => {
					if (data.type === 'img') {
						const imageBlob = new Blob([data.content], { type: data.fileType });
						const imageUrl = URL.createObjectURL(imageBlob);
						app.messageList.push({ type: 'img', name: 'friend', content: imageUrl });
					} else {
						app.messageList.push({ type: 'text', name: 'friend', content: data.content });
					}
				});
			});
		});
	</script>
</body>

</html>

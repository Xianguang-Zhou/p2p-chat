<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>P2P chat</title>
	<link href="style.css" rel="stylesheet">
</head>

<body>
	<form id="app" onsubmit="return false">
		<div class="line">
			<label>Peer ID: </label><input v-model="selfPeerId" readonly>
			<button id="copySelfPeerId" v-if="selfPeerId">copy</button>
		</div>
		<div class="line">
			<label>Friend peer ID: </label>
			<input v-model="friendPeerId">
			<input type="button" value="connect" v-on:click="connectPeer" v-if="selfPeerId">
		</div>
		<div class="line">
			<label>Status: {{ status }}</label>
		</div>
		<div id="messagesContainer" class="line">
			<p v-for="(msg, index) in messageList" :key="index" class="message">
				<span class="messageName">{{ msg.name }}</span>:
				<template v-if="msg.type === 'img'">
					<br><img v-bind:src="msg.content" v-on:load="onImageLoad">
				</template>
				<template v-else>
					{{ msg.content }}
				</template>
			</p>
		</div>
		<div class="line">
			<input type="button" value="image" v-on:click="selectImages">
		</div>
		<div class="line">
			<textarea cols="45" rows="4" v-model="message" v-on:keyup.ctrl.enter.exact.stop="sendMessage"></textarea>
		</div>
		<input type="button" value="send" v-on:click="sendMessage">
		<input type="file" id="imageInput" multiple v-on:change="sendImages">
	</form>
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue"></script>
	<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/peerjs@0.3.20/dist/peer.min.js"></script>
	<script>
		$(document).ready(function () {
			const app = new Vue({
				el: '#app',
				data: {
					friendPeerId: '',
					selfPeerId: '',
					status: 'getting peer ID...',
					message: '',
					messageList: []
				},
				methods: {
					connectPeer: function () {
						this.status = 'connecting...';
						const conn = peer.connect(this.friendPeerId);
						this.conn = conn;
						conn.on('open', () => {
							this.friendPeerId = conn.peer;
							this.status = 'connected';
						});
						conn.on('close', () => {
							this.status = 'disconnected';
						});
						conn.on('data', (data) => {
							if (data.type === 'img') {
								const imageBlob = new Blob([data.content], { type: data.fileType });
								const imageUrl = URL.createObjectURL(imageBlob);
								this.messageList.push({ type: 'img', name: 'friend', content: imageUrl });
							} else {
								this.messageList.push({ type: 'text', name: 'friend', content: data.content });
							}
						});
					},
					sendMessage: function () {
						this.messageList.push({ type: 'text', name: 'me', content: this.message });
						this.conn.send({ type: 'text', content: this.message });
						this.message = '';
					},
					sendImages: function (event) {
						for (const imageFile of event.target.files) {
							const imageUrl = URL.createObjectURL(imageFile);
							this.messageList.push({ type: 'img', name: 'me', content: imageUrl });
							const reader = new FileReader();
							reader.onload = function (readerEvent) {
								app.conn.send({ type: 'img', fileType: imageFile.type, content: readerEvent.target.result });
							};
							reader.readAsArrayBuffer(imageFile);
						}
					},
					onImageLoad: function (event) {
						const src = event.target.src;
						if (src.startsWith('blob:')) {
							window.URL.revokeObjectURL(src);
						}
					},
					selectImages: function () {
						$('#imageInput').click();
					}
				},
			});
			const clipboard = new ClipboardJS('#copySelfPeerId', {
				text: function (trigger) {
					return app.selfPeerId;
				}
			});
			const peer = new Peer();
			peer.on('open', (id) => {
				app.selfPeerId = id;
				app.status = 'online';
			});
			peer.on('connection', (conn) => {
				app.conn = conn;
				conn.on('open', () => {
					app.friendPeerId = conn.peer;
					app.status = 'connected';
				});
				conn.on('close', () => {
					app.status = 'disconnected';
				});
				conn.on('data', (data) => {
					if (data.type === 'img') {
						const imageBlob = new Blob([data.content], { type: data.fileType });
						const imageUrl = URL.createObjectURL(imageBlob);
						app.messageList.push({ type: 'img', name: 'friend', content: imageUrl });
					} else {
						app.messageList.push({ type: 'text', name: 'friend', content: data.content });
					}
				});
			});
		});
	</script>
</body>

</html>